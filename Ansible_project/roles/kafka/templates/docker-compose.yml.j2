version: '3'
services:
  zookeeper-kafka:
    image: confluentinc/cp-zookeeper:7.8.0
    hostname: zookeeper-kafka
    container_name: zookeeper-kafka
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_SASL_ENABLED: "true"
      ZOOKEEPER_AUTH_PROVIDER_1: org.apache.zookeeper.server.auth.DigestAuthenticationProvider
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/zookeeper_jaas.conf"  
      ZOOKEEPER_SERVER_CNXN_FACTORY: org.apache.zookeeper.server.NIOServerCnxnFactory
    volumes:
      - ./zk-data:/var/lib/zookeeper/data
      - ./zk-logs:/var/lib/zookeeper/log
      - ./config/zookeeper_jaas.conf:/etc/kafka/zookeeper_jaas.conf

  kafka:
    image: confluentinc/cp-kafka:7.8.0
    hostname: kafka
    container_name: kafka
    depends_on:
      - zookeeper-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-kafka:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_PLAINTEXT:SASL_PLAINTEXT
      KAFKA_LISTENERS: SASL_PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: SASL_PLAINTEXT://{{ kafka_host }}:9092
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_SECURITY_INTER_BROKER_PROTOCOL: SASL_PLAINTEXT
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"
      KAFKA_HEAP_OPTS: "-Xmx1G -Xms1G"  # 增加Kafka的堆内存

      # 添加以下配置参数来增加消息大小限制
      KAFKA_MESSAGE_MAX_BYTES: 1073741824       # 1GB
      KAFKA_REPLICA_FETCH_MAX_BYTES: 1073741824 # 1GB
      KAFKA_FETCH_MESSAGE_MAX_BYTES: 1073741824 # 1GB
      # 增加socket缓冲区大小
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 102400000
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 102400000

      KAFKA_LOG_RETENTION_HOURS: 72  # 保留日志3天(3*24=72小时)
      KAFKA_LOG_RETENTION_BYTES: 1073741824  # 每个分区的日志最大大小，这里设为1GB
      KAFKA_LOG_SEGMENT_BYTES: 536870912  # 日志段文件大小，这里设为512MB
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000  # 检查日志是否需要删除的时间间隔，这里设为5分钟
      KAFKA_LOG_CLEANUP_POLICY: delete  # 日志清理策略，默认为delete(删除)
      KAFKA_DELETE_RETENTION_MS: 86400000  # 标记为删除的数据保留时间，这里设为1天

      KAFKA_PRODUCER_QUEUE_BUFFERING_MAX_MESSAGES: 100000
      KAFKA_PRODUCER_QUEUE_BUFFERING_MAX_KBYTES: 10485760
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ZOOKEEPER_SASL_CLIENT: "true"
      KAFKA_ZOOKEEPER_SET_ACL: "false"
    volumes:
      - ./kafka-data:/var/lib/kafka/data
      - ./config/kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf