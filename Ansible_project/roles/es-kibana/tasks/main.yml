---
# ES-Kibana å®‰è£…å’Œé…ç½®ä»»åŠ¡ - ç›´æ¥è°ƒç”¨install_es.shè„šæœ¬

- name: "æ£€æŸ¥ç³»ç»Ÿè¦æ±‚"
  fail:
    msg: "æ­¤roleä»…æ”¯æŒUbuntu/Debianç³»ç»Ÿ"
  when: ansible_os_family != "Debian"

- name: "å¤åˆ¶install_es.shå®‰è£…è„šæœ¬åˆ°ç›®æ ‡æœåŠ¡å™¨"
  copy:
    src: install_es.sh
    dest: "{{ install_script_path }}"
    mode: '0755'
    owner: root
    group: root
  become: true

- name: "å¤åˆ¶init.es.shåˆå§‹åŒ–è„šæœ¬åˆ°ç›®æ ‡æœåŠ¡å™¨"
  copy:
    src: init.es.sh
    dest: "{{ init_script_path }}"
    mode: '0755'
    owner: root
    group: root
  become: true

- name: "æ£€æŸ¥Elasticsearchæ˜¯å¦å·²å®‰è£…"
  stat:
    path: "{{ es_home }}/bin/elasticsearch"
  register: es_installed

- name: "æ£€æŸ¥Kibanaæ˜¯å¦å·²å®‰è£…"
  stat:
    path: "{{ kibana_home }}/bin/kibana"
  register: kibana_installed

- name: "æ˜¾ç¤ºå®‰è£…å‰ä¿¡æ¯"
  debug:
    msg: |
      å‡†å¤‡å®‰è£…ELK Stack...
      - Elasticsearchç‰ˆæœ¬: {{ es_version }}
      - Kibanaç‰ˆæœ¬: {{ kibana_version }}
      - é›†ç¾¤åç§°: {{ cluster_name }}
      - èŠ‚ç‚¹åç§°: {{ node_name }}
      - ESå¯†ç : {{ es_password }}
      - Kibanaå¯†ç : {{ kibana_password }}
      - æ˜¯å¦å·²å®‰è£…ES: {{ es_installed.stat.exists }}
      - æ˜¯å¦å·²å®‰è£…Kibana: {{ kibana_installed.stat.exists }}

- name: "æ‰§è¡ŒELK Stackå®‰è£…è„šæœ¬ (å¼‚æ­¥æ‰§è¡Œ)"
  shell: |
    nohup {{ install_script_path }} > /tmp/elk_install.log 2>&1 &
    echo $!
  become: true
  register: elk_install_pid
  async: 3600  # 1å°æ—¶è¶…æ—¶
  poll: 0      # ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…å®Œæˆ
  when: not (es_installed.stat.exists and kibana_installed.stat.exists)

- name: "æ˜¾ç¤ºå®‰è£…å¼€å§‹ä¿¡æ¯"
  debug:
    msg: |
      ELK Stack å®‰è£…å·²å¼€å§‹...
      - è„šæœ¬è·¯å¾„: {{ install_script_path }}
      - æ—¥å¿—æ–‡ä»¶: /tmp/elk_install.log
      - é¢„è®¡æ—¶é—´: 10-30åˆ†é’Ÿ
      - ä»»åŠ¡ID: {{ elk_install_pid.ansible_job_id }}
      - ç›‘æ§é¢‘ç‡: æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¿›åº¦
  when: not (es_installed.stat.exists and kibana_installed.stat.exists)

- name: "ç›‘æ§å®‰è£…è¿›åº¦ - æ ‡å‡†å¾ªç¯æ–¹å¼"
  async_status:
    jid: "{{ elk_install_pid.ansible_job_id }}"
  register: elk_status
  until: elk_status.finished
  retries: 120
  delay: 30
  when: not (es_installed.stat.exists and kibana_installed.stat.exists) and elk_install_pid is defined

- name: "æ˜¾ç¤ºå®‰è£…ç›‘æ§å®Œæˆä¿¡æ¯"
  shell: |
    echo "=== ğŸ“Š ELKå®‰è£…ç›‘æ§å®Œæˆ ($(date '+%Y-%m-%d %H:%M:%S')) ==="
    echo ""
    if [ -f "/tmp/elk_install.log" ]; then
      LOG_SIZE=$(wc -l < /tmp/elk_install.log)
      echo "ğŸ“„ æœ€ç»ˆæ—¥å¿—æ–‡ä»¶: $LOG_SIZE è¡Œ"
      echo ""
      
      echo "ğŸ” å®‰è£…é˜¶æ®µæ£€æŸ¥:"
      if grep -q "å¼€å§‹å®‰è£…" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… å®‰è£…å·²å¼€å§‹"
      fi
      if grep -q "ä¸‹è½½.*Elasticsearch\|Downloading.*elasticsearch" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… Elasticsearch ä¸‹è½½å®Œæˆ"
      fi
      if grep -q "è§£å‹.*Elasticsearch\|Extracting.*elasticsearch" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… Elasticsearch è§£å‹å®Œæˆ"
      fi
      if grep -q "å¯åŠ¨.*elasticsearch\|Starting.*elasticsearch\|elasticsearch.*started" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… Elasticsearch æœåŠ¡å¯åŠ¨"
      fi
      if grep -q "ä¸‹è½½.*Kibana\|Downloading.*kibana" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… Kibana ä¸‹è½½å®Œæˆ"
      fi
      if grep -q "å¯åŠ¨.*kibana\|Starting.*kibana\|kibana.*started" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… Kibana æœåŠ¡å¯åŠ¨"
      fi
      if grep -q "å¯†ç .*è®¾ç½®\|password.*set\|å¯†ç è®¾ç½®å®Œæˆ" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… å¯†ç é…ç½®å®Œæˆ"
      fi
      if grep -q "å®‰è£….*å®Œæˆ\|installation.*complete\|Setup completed" /tmp/elk_install.log 2>/dev/null; then
        echo "  âœ… å®‰è£…å®Œæˆ"
      fi
      
      echo ""
      echo "ğŸ“‹ å®‰è£…æ—¥å¿—æ‘˜è¦ (æœ€å20è¡Œ):"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      # ç§»é™¤é¢œè‰²ç ã€ç©ºå­—ç¬¦å’ŒäºŒè¿›åˆ¶å­—ç¬¦ï¼Œåªæ˜¾ç¤ºå¯è¯»æ–‡æœ¬
      tail -20 /tmp/elk_install.log | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\0' | grep -v '^[[:space:]]*$' | head -20
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
      echo "âš ï¸ å®‰è£…æ—¥å¿—æ–‡ä»¶æœªæ‰¾åˆ°"
    fi
  register: final_monitor_output
  when: not (es_installed.stat.exists and kibana_installed.stat.exists) and elk_install_pid is defined

- name: "æ˜¾ç¤ºå®‰è£…ç›‘æ§å®Œæˆä¿¡æ¯"
  debug:
    var: final_monitor_output.stdout_lines
  when: final_monitor_output is defined and final_monitor_output.stdout_lines is defined

- name: "æ£€æŸ¥å®‰è£…è„šæœ¬æœ€ç»ˆçŠ¶æ€"
  shell: |
    echo "=== ğŸ“‹ å®‰è£…è„šæœ¬çŠ¶æ€æ£€æŸ¥ ==="
    if [ -f "/tmp/elk_install.log" ]; then
      # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      if grep -i "error\|failed\|æ— æ³•\|å¤±è´¥" /tmp/elk_install.log >/dev/null 2>&1; then
        echo "âš ï¸ å‘ç°å¯èƒ½çš„é”™è¯¯ä¿¡æ¯:"
        grep -i "error\|failed\|æ— æ³•\|å¤±è´¥" /tmp/elk_install.log | tail -5
        echo ""
      fi
      
      # æ£€æŸ¥æ˜¯å¦æˆåŠŸå®Œæˆ - ä½¿ç”¨å¤šç§åˆ¤æ–­æ ‡å‡†
      if grep -q "å®‰è£….*å®Œæˆ\|installation.*complete\|Setup completed\|successfully\|å¯åŠ¨.*kibana\|kibana.*started\|Kibana server is now running" /tmp/elk_install.log >/dev/null 2>&1; then
        echo "âœ… å®‰è£…è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        exit 0
      else
        # å¦‚æœæ²¡æœ‰æ˜ç¡®çš„å®Œæˆæ ‡å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é”™è¯¯
        if grep -qi "fatal\|critical\|cannot\|fail.*start" /tmp/elk_install.log >/dev/null 2>&1; then
          echo "âŒ å‘ç°ä¸¥é‡é”™è¯¯ï¼Œå®‰è£…å¤±è´¥"
          exit 1
        else
          echo "âš ï¸ å®‰è£…çŠ¶æ€ä¸æ˜ç¡®ï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯"
          echo "æœ€å10è¡Œæœ‰æ•ˆæ—¥å¿—:"
          tail -20 /tmp/elk_install.log | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\0' | grep -v '^[[:space:]]*$' | tail -10
          exit 2  # ä½¿ç”¨ä¸åŒçš„é€€å‡ºç è¡¨ç¤ºçŠ¶æ€ä¸æ˜ç¡®
        fi
      fi
    else
      echo "âŒ å®‰è£…æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
      exit 1
    fi
  register: script_status_check
  failed_when: false  # ä¸è®©è¿™ä¸ªä»»åŠ¡å¤±è´¥ï¼Œåªæ˜¯æ”¶é›†ä¿¡æ¯
  when: not (es_installed.stat.exists and kibana_installed.stat.exists) and elk_install_pid is defined

- name: "æ˜¾ç¤ºè„šæœ¬çŠ¶æ€æ£€æŸ¥ç»“æœ"  
  debug:
    var: script_status_check.stdout_lines
  when: script_status_check is defined and script_status_check.stdout_lines is defined

- name: "è¯Šæ–­å®‰è£…æ—¥å¿—é—®é¢˜"
  shell: |
    if [ -f "/tmp/elk_install.log" ]; then
      echo "=== ğŸ“Š æ—¥å¿—æ–‡ä»¶è¯Šæ–­ ==="
      echo "æ–‡ä»¶å¤§å°: $(ls -lh /tmp/elk_install.log | awk '{print $5}')"
      echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/elk_install.log)"
      echo "ç©ºå­—ç¬¦æ•°é‡: $(grep -c '\x00' /tmp/elk_install.log || echo 0)"
      echo "æœ€åä¿®æ”¹æ—¶é—´: $(stat -c %y /tmp/elk_install.log)"
      echo ""
      echo "=== è„šæœ¬è¿›ç¨‹çŠ¶æ€ ==="
      if pgrep -f "{{ install_script_path }}" > /dev/null; then
        echo "â³ å®‰è£…è„šæœ¬ä»åœ¨è¿è¡Œ"
        echo "è¿›ç¨‹ä¿¡æ¯: $(ps aux | grep {{ install_script_path }} | grep -v grep)"
      else
        echo "âš ï¸ å®‰è£…è„šæœ¬è¿›ç¨‹å·²ç»“æŸ"
      fi
      echo ""
      echo "=== æœ€åæœ‰æ•ˆæ—¥å¿—å†…å®¹ ==="
      tail -30 /tmp/elk_install.log | tr -d '\0' | grep -v '^[[:space:]]*$' | tail -10
    else
      echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
    fi
  register: log_diagnosis
  when: 
    - script_status_check is defined 
    - script_status_check.rc is defined
    - script_status_check.rc != 0

- name: "æ˜¾ç¤ºæ—¥å¿—è¯Šæ–­ç»“æœ"
  debug:
    var: log_diagnosis.stdout_lines
  when: log_diagnosis is defined and log_diagnosis.stdout_lines is defined

- name: "æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸ"
  debug:
    msg: |
      âš ï¸ æ³¨æ„ï¼šå®‰è£…è„šæœ¬çŠ¶æ€æ£€æŸ¥æœªé€šè¿‡
      - è„šæœ¬é€€å‡ºç : {{ script_status_check.rc | default('æœªçŸ¥') }}
      - çŠ¶æ€: {{ 'ä¸¥é‡é”™è¯¯' if script_status_check.rc == 1 else 'çŠ¶æ€ä¸æ˜ç¡®ï¼Œç»§ç»­éªŒè¯' if script_status_check.rc == 2 else 'å…¶ä»–é—®é¢˜' }}
      - ç»§ç»­è¿›è¡ŒæœåŠ¡çŠ¶æ€éªŒè¯ä»¥ç¡®è®¤å®é™…å®‰è£…ç»“æœ...
  when: 
    - script_status_check is defined 
    - script_status_check.rc is defined
    - script_status_check.rc != 0

- name: "å®‰è£…è„šæœ¬ä¸¥é‡å¤±è´¥æ£€æŸ¥"
  fail:
    msg: |
      ELK Stackå®‰è£…ä¸¥é‡å¤±è´¥ï¼
      - æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯ï¼Œæ— æ³•ç»§ç»­
      - è¯·æ£€æŸ¥å®‰è£…æ—¥å¿—: /tmp/elk_install.log
      - å»ºè®®é‡æ–°è¿è¡Œå®‰è£…æˆ–æ‰‹åŠ¨æ’æŸ¥é—®é¢˜
  when: 
    - script_status_check is defined 
    - script_status_check.rc is defined
    - script_status_check.rc == 1

- name: "ç­‰å¾…ElasticsearchæœåŠ¡å¯åŠ¨(ä¸‹è½½å®‰è£…åŒ…ï¼Œæ—¶é—´è¾ƒä¹…)"
  wait_for:
    host: "{{ network_host if network_host != '0.0.0.0' else ansible_default_ipv4.address }}"
    port: "{{ http_port }}"
    delay: 30
    timeout: 900
    state: started
  register: es_port_check

- name: "ç­‰å¾…KibanaæœåŠ¡å¯åŠ¨(ä¸‹è½½å®‰è£…åŒ…ï¼Œæ—¶é—´è¾ƒä¹…)"
  wait_for:
    host: "{{ network_host if network_host != '0.0.0.0' else ansible_default_ipv4.address }}"
    port: "{{ kibana_port }}"
    delay: 30
    timeout: 900
    state: started
  register: kibana_port_check

- name: "éªŒè¯Elasticsearch HTTPSå“åº”"
  uri:
    url: "https://{{ ansible_default_ipv4.address }}:{{ http_port }}"
    method: GET
    user: "elastic"
    password: "{{ es_password }}"
    force_basic_auth: yes
    validate_certs: no  # å¿½ç•¥è‡ªç­¾è¯ä¹¦
    status_code: [200, 401, 403]
    timeout: 30
  register: es_https_check
  retries: 5
  delay: 15
  ignore_errors: true

- name: "æ˜¾ç¤ºElasticsearchè¿æ¥ç»“æœ"
  debug:
    msg: |
      Elasticsearch HTTPSæ£€æŸ¥ç»“æœ:
      - URL: https://{{ ansible_default_ipv4.address }}:{{ http_port }}
      - çŠ¶æ€ç : {{ es_https_check.status | default('è¿æ¥å¤±è´¥') }}
      - å“åº”: {{ 'æˆåŠŸ' if es_https_check.status == 200 else 'éœ€è¦è®¤è¯æˆ–æƒé™é—®é¢˜' if es_https_check.status in [401, 403] else 'è¿æ¥å¤±è´¥' }}

- name: "éªŒè¯Kibana HTTPå“åº”"
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ kibana_port }}"
    method: GET
    status_code: [200, 302, 401]
    timeout: 30
  register: kibana_http_check
  retries: 5
  delay: 15
  ignore_errors: true

- name: "æ˜¾ç¤ºKibanaè¿æ¥ç»“æœ"
  debug:
    msg: |
      Kibana HTTPæ£€æŸ¥ç»“æœ:
      - URL: http://{{ ansible_default_ipv4.address }}:{{ kibana_port }}
      - çŠ¶æ€ç : {{ kibana_http_check.status | default('è¿æ¥å¤±è´¥') }}
      - å“åº”: {{ 'æˆåŠŸ' if kibana_http_check.status in [200, 302] else 'éœ€è¦è®¤è¯' if kibana_http_check.status == 401 else 'è¿æ¥å¤±è´¥' }}

- name: "æ£€æŸ¥ElasticsearchæœåŠ¡çŠ¶æ€"
  systemd:
    name: elasticsearch
  register: es_service_status
  become: true

- name: "æ£€æŸ¥KibanaæœåŠ¡çŠ¶æ€"
  systemd:
    name: kibana
  register: kibana_service_status
  become: true

- name: "è®¾ç½®IPåœ°å€é…ç½®"
  set_fact:
    internal_ip: "{{ elastic_intranet_ip }}"
    public_ip: "{{ elastic_public_ip }}"

- name: "æ¸…ç†å®‰è£…è„šæœ¬"
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ install_script_path }}"
    - "{{ init_script_path }}"
  become: true

- name: "æ˜¾ç¤ºå®‰è£…å®Œæˆä¿¡æ¯"
  debug:
    msg: |
      =========================================
      ELK Stack å®‰è£…å®Œæˆï¼
      =========================================
      
      å®‰è£…è·¯å¾„:
      - Elasticsearch: {{ es_home }}
      - Kibana: {{ kibana_home }}
      
      æœåŠ¡çŠ¶æ€:
      - Elasticsearch: {{ 'Running' if es_service_status.status.ActiveState == 'active' else 'Not Running' }}
      - Kibana: {{ 'Running' if kibana_service_status.status.ActiveState == 'active' else 'Not Running' }}
      
      è®¿é—®åœ°å€:
      - Elasticsearch HTTPS: https://{{ public_ip }}:{{ http_port }}
      - Kibana HTTP: http://{{ public_ip }}:{{ kibana_port }}
      
      è¿æ¥æµ‹è¯•:
      - ESçŠ¶æ€: {{ 'âœ“ è¿æ¥æˆåŠŸ' if es_https_check.status == 200 else 'âš  éœ€è¦æ£€æŸ¥' if es_https_check.status in [401, 403] else 'âœ— è¿æ¥å¤±è´¥' }}
      - KibanaçŠ¶æ€: {{ 'âœ“ è¿æ¥æˆåŠŸ' if kibana_http_check.status in [200, 302] else 'âš  éœ€è¦æ£€æŸ¥' if kibana_http_check.status == 401 else 'âœ— è¿æ¥å¤±è´¥' }}
      
      è®¤è¯ä¿¡æ¯:
      - Elasticsearchç”¨æˆ·: elastic
      - Elasticsearchå¯†ç : {{ es_password }}
      - Kibanaç”¨æˆ·: elastic (ç™»å½•Kibanaä½¿ç”¨)
      - Kibanaå¯†ç : {{ es_password }}
      
      æœåŠ¡ç®¡ç†å‘½ä»¤:
      - é‡å¯ES: systemctl restart elasticsearch
      - é‡å¯Kibana: systemctl restart kibana
      - æŸ¥çœ‹ESçŠ¶æ€: systemctl status elasticsearch
      - æŸ¥çœ‹KibanaçŠ¶æ€: systemctl status kibana
      - æŸ¥çœ‹ESæ—¥å¿—: journalctl -u elasticsearch -f
      - æŸ¥çœ‹Kibanaæ—¥å¿—: journalctl -u kibana -f
      
      ç´¢å¼•åˆå§‹åŒ–: âœ“ å·²å®Œæˆ
      æ—¥å¿—ç´¢å¼•: access_logs, block_logs, error_logs, api_logs
      ç”Ÿå‘½å‘¨æœŸ: {{ expired_days }}å¤©è‡ªåŠ¨åˆ é™¤
      
      å¯†ç æ–‡ä»¶: {{ es_home }}/elastic_credentials.txt
      =========================================