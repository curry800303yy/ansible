---
# CDN ç®¡ç†ç³»ç»Ÿå®Œæ•´éƒ¨ç½² Playbook
# ä½¿ç”¨æ–¹æ³•: ansible-playbook -i inventory/hosts site.yml

# 1. éƒ¨ç½² ELK æ—¥å¿—ç³»ç»Ÿ (ES + Kibana)
- name: éƒ¨ç½² ELK æ—¥å¿—ç³»ç»Ÿ
  hosts: es01_server
  become: true
  tags: ['es-kibana', 'elk', 'logs', 'search']
  vars:
    es_version: "8.16.4"
    kibana_version: "8.16.4"
    cluster_name: "ELK-Cluster"
    node_name: "elk-node1"
    es_password: "ESPWlajKy5p137mOE9c2"
    kibana_password: "ESPWlajKy5p137mOE9c2"
    expired_days: 7
    index_setting: '"number_of_replicas":0,'

  pre_tasks:
    - name: æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
      fail:
        msg: "æ­¤éƒ¨ç½²ä»…æ”¯æŒUbuntu/Debianç³»ç»Ÿ"
      when: ansible_os_family != "Debian"

  roles:
    - es-kibana



# 2. éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ (Prometheus + N9Eå¤œèº)
- name: éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
  hosts: monitor_server
  become: true
  tags: ['monitor', 'prometheus', 'n9e', 'monitoring']
  vars:
    monitor_auto_mode: true
    prometheus_port: 9090
    n9e_port: 17000

  pre_tasks:
    - name: æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
      fail:
        msg: "æ­¤éƒ¨ç½²ä»…æ”¯æŒUbuntuç³»ç»Ÿ"
      when: ansible_os_family != "Debian"

  roles:
    - monitor

# 3. éƒ¨ç½² CDN ç®¡ç†ç³»ç»ŸæœåŠ¡
- name: éƒ¨ç½² CDN ç®¡ç†ç³»ç»ŸæœåŠ¡
  hosts: web_server
  become: true
  gather_facts: true
  tags: ['cdn', 'application']
  roles:
    # ========================================
    # Docker ç¯å¢ƒ - CDN æœåŠ¡å™¨éœ€è¦
    # ========================================
    - role: docker
      tags: ['docker', 'infrastructure', 'cdn']

    # ========================================
    # åŸºç¡€æœåŠ¡éƒ¨ç½² - æŒ‰ä¾èµ–é¡ºåºéƒ¨ç½²
    # ========================================
    - role: web-mysql
      tags: ['web-mysql', 'database']
    
    - role: redis
      tags: ['redis', 'cache']
    
    - role: kafka
      tags: ['kafka', 'message-queue']
    
    # ========================================
    # è®¤è¯ä»£ç†æœåŠ¡ - åœ¨å‰åç«¯å®¹å™¨ä¹‹å‰éƒ¨ç½²
    # ========================================
    - role: auth-agent
      tags: ['auth-agent', 'authentication']
    
    # ========================================
    # MCDN Agent Python æœåŠ¡ - åœ¨ auth-agent ä¹‹åéƒ¨ç½²
    # ========================================
    - role: mcdn-agent-py
      tags: ['mcdn-agent-py', 'agent']
    
    # ========================================
    # å‰åç«¯åº”ç”¨æœåŠ¡éƒ¨ç½²
    # ========================================
    - role: console
      tags: ['console', 'frontend']
    
    - role: api-go
      tags: ['api-go', 'backend']
 
    - role: admin-out
      tags: ['admin-out', 'frontend']

    - role: admin-api-go
      tags: ['admin-api-go', 'backend']

    # ========================================
    # WebæœåŠ¡å™¨ - åœ¨æ‰€æœ‰åç«¯æœåŠ¡éƒ¨ç½²å®Œæˆåéƒ¨ç½²
    # ========================================
    - role: web-nginx
      tags: ['web-nginx', 'nginx', 'web-server']




# 4. æ›´æ–° Prometheus ç›‘æ§é…ç½®ï¼ˆéœ€è¦åœ¨ web_server éƒ¨ç½²å®Œæˆåï¼‰
- name: æ›´æ–° Prometheus ç›‘æ§é…ç½®
  hosts: monitor_server
  become: true
  tags: ['prometheus-config', 'monitor-config']
  vars:
    admin_api_go_work_dir: "/opt/admin-api-go"
    prometheus_config_path: "/apps/prometheus/prometheus.yml"
  
  pre_tasks:
    - name: æ£€æŸ¥ monitor_server æ˜¯å¦å·²éƒ¨ç½²
      stat:
        path: /apps/prometheus/prometheus.yml
      register: prometheus_exists
      failed_when: false

    - name: è·³è¿‡æœªéƒ¨ç½²çš„ç›‘æ§ç³»ç»Ÿ
      meta: end_play
      when: not prometheus_exists.stat.exists

  tasks:
    - name: ç­‰å¾… admin-api-go æœåŠ¡å°±ç»ª
      wait_for:
        host: "{{ hostvars[groups['web_server'][0]]['ansible_host'] }}"
        port: 9999
        delay: 10
        timeout: 120
      delegate_to: localhost
      when: groups['web_server'] is defined and groups['web_server'] | length > 0

    - name: å¤‡ä»½å½“å‰ Prometheus é…ç½®
      copy:
        src: "{{ prometheus_config_path }}"
        dest: "{{ prometheus_config_path }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
      become: true

    - name: æ£€æŸ¥ client.key æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      stat:
        path: "{{ admin_api_go_work_dir }}/certs/ca/client.key"
      register: client_key_file
      delegate_to: "{{ groups['web_server'][0] }}"
      become: true
      when: groups['web_server'] is defined and groups['web_server'] | length > 0
      
    - name: è·å– client.key çš„ MD5 å€¼
      shell: |
        md5sum {{ admin_api_go_work_dir }}/certs/ca/client.key | awk '{print $1}'
      register: client_key_md5
      delegate_to: "{{ groups['web_server'][0] }}"
      become: true
      when: 
        - groups['web_server'] is defined 
        - groups['web_server'] | length > 0
        - client_key_file.stat.exists
        
    - name: æ˜¾ç¤ºè·å–çš„ MD5 å€¼
      debug:
        msg: "Client key MD5: {{ client_key_md5.stdout | default('æœªè·å–åˆ°') }}"
      when: client_key_md5 is defined

    - name: ä» admin-api-go è·å– Prometheus é…ç½®
      shell: |
        # ä½¿ç”¨è·å–åˆ°çš„ key
        key="{{ client_key_md5.stdout | default('') }}"
        
        if [ -z "$key" ]; then
          echo "ERROR: æ— æ³•è·å– client.key çš„ MD5"
          exit 1
        fi
        
        echo "ä½¿ç”¨ key: $key"
        echo "ä¸‹è½½ URL: https://{{ hostvars[groups['web_server'][0]]['ansible_host'] }}:9999/config?key=${key}"
        
        # ä¸‹è½½é…ç½®
        curl -o {{ prometheus_config_path }}.new -k -f -v -m 30 \
          "https://{{ hostvars[groups['web_server'][0]]['ansible_host'] }}:9999/config?key=${key}" 2>&1
        
        curl_result=$?
        echo "Curl è¿”å›ç : $curl_result"
        
        if [ $curl_result -eq 0 ]; then
          echo "ä¸‹è½½æˆåŠŸï¼ŒéªŒè¯é…ç½®æ–‡ä»¶..."
          # éªŒè¯é…ç½®æ–‡ä»¶
          if /apps/prometheus/promtool check config {{ prometheus_config_path }}.new >/dev/null 2>&1; then
            mv {{ prometheus_config_path }}.new {{ prometheus_config_path }}
            echo "SUCCESS"
          else
            echo "CONFIG_INVALID"
            rm -f {{ prometheus_config_path }}.new
            exit 1
          fi
        else
          echo "DOWNLOAD_FAILED"
          exit 1
        fi
      register: prometheus_config_update
      become: true
      when: 
        - groups['web_server'] is defined 
        - groups['web_server'] | length > 0
        - client_key_md5 is defined 
        - client_key_md5.stdout is defined
        
    - name: æ˜¾ç¤ºé…ç½®è·å–ç»“æœ
      debug:
        msg: "é…ç½®ä¸‹è½½ç»“æœ: {{ prometheus_config_update.stdout_lines | default([]) }}"
      when: prometheus_config_update is defined

    - name: é‡å¯ Prometheus æœåŠ¡
      systemd:
        name: prometheus
        state: restarted
      become: true
      when: 
        - prometheus_config_update is defined
        - "'SUCCESS' in prometheus_config_update.stdout"

    - name: æ˜¾ç¤ºé…ç½®æ›´æ–°ç»“æœ
      debug:
        msg:
          - "=========================================="
          - "Prometheus é…ç½®æ›´æ–°å®Œæˆ"
          - "=========================================="
          - "é…ç½®æº: https://{{ hostvars[groups['web_server'][0]]['ansible_host'] }}:9999/config"
          - "é…ç½®æ–‡ä»¶: {{ prometheus_config_path }}"
          - "æ›´æ–°çŠ¶æ€: {{ prometheus_config_update.stdout | default('SKIPPED') }}"
          - "PrometheusæœåŠ¡: {{ 'Restarted' if 'SUCCESS' in prometheus_config_update.stdout else 'Not restarted' }}"
          - "=========================================="
      when: prometheus_config_update is defined

# 5ã€å…¨é‡æ›´æ–°å®Œæˆ
- name: éƒ¨ç½²å®ŒæˆéªŒè¯
  hosts: all
  become: false
  tags: ['verify', 'info']
  tasks:
    - name: æ˜¾ç¤ºå®Œæ•´éƒ¨ç½²ä¿¡æ¯
      debug:
        msg: |
          ğŸ‰ CDN ç®¡ç†ç³»ç»Ÿå®Œæ•´éƒ¨ç½²å®Œæˆï¼
          
          ğŸ“‹ éƒ¨ç½²çš„æœåŠ¡åˆ—è¡¨:
          
          ğŸ”§ åŸºç¡€è®¾æ–½:
          - Docker ç¯å¢ƒ: æ‰€æœ‰æœåŠ¡å™¨
          
          ğŸ—„ï¸ æ•°æ®å­˜å‚¨æœåŠ¡:
          - MySQL æ•°æ®åº“: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          - Redis ç¼“å­˜: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡:
          - Kafka: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸŒ Web æœåŠ¡:
          - Nginx: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ” è®¤è¯æœåŠ¡:
          - Auth Agent: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ” æœç´¢å’Œåˆ†æ:
          - Elasticsearch: {{ groups['es01_server'] | default(['æœªé…ç½®']) | join(', ') }}
          - Kibana: {{ groups['es01_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤:
          - Janusec WAF: {{ groups['janusec_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ“Š ç›‘æ§ç³»ç»Ÿ:
          - Prometheus: {{ groups['monitor_server'] | default(['æœªé…ç½®']) | join(', ') }}
          - N9Eå¤œèº: {{ groups['monitor_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸŒ CDN ç®¡ç†ç³»ç»Ÿ:
          - Console å‰ç«¯: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          - API æœåŠ¡: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          - ç®¡ç†åå°: {{ groups['web_server'] | default(['æœªé…ç½®']) | join(', ') }}
          
          ğŸ”— è®¿é—®åœ°å€:
          {% if groups['web_server'] is defined %}
          - MySQL: {{ groups['web_server'][0] }}:3306
          - Redis: {{ groups['web_server'][0] }}:6379
          - Kafka: {{ groups['web_server'][0] }}:9092
          - Nginx: http://{{ groups['web_server'][0] }}:80
          - Auth Agent: {{ groups['web_server'][0] }}:10111, {{ groups['web_server'][0] }}:10211
          - CDN æ§åˆ¶å° API: http://{{ groups['web_server'][0] }}:25671
          - CDN ç®¡ç† API: http://{{ groups['web_server'][0] }}:25670
          {% endif %}
          {% if groups['es01_server'] is defined %}
          - Kibana: http://{{ groups['es01_server'][0] }}:5601
          {% endif %}
          {% if groups['janusec_server'] is defined %}
          - Janusec: http://{{ groups['janusec_server'][0] }}
          {% endif %}
          {% if groups['monitor_server'] is defined %}
          - Prometheus: http://{{ groups['monitor_server'][0] }}:9090 (admin/prometheus098)
          - N9Eå¤œèº: http://{{ groups['monitor_server'][0] }}:17000 (root/root.2020)
          {% endif %}
          
          ğŸ“ å¸¸ç”¨å‘½ä»¤:
          - æŸ¥çœ‹æ‰€æœ‰å®¹å™¨: docker ps
          - æŸ¥çœ‹ç½‘ç»œ: docker network ls
          - æŸ¥çœ‹æ—¥å¿—: docker logs <container_name>
          - æŸ¥çœ‹åŸºç¡€æœåŠ¡çŠ¶æ€: docker compose ps
          
          âš ï¸  æ³¨æ„äº‹é¡¹:
          1. è¯·ç¡®ä¿é˜²ç«å¢™å·²å¼€æ”¾ç›¸åº”ç«¯å£ (80, 443, 3306, 6379, 5672, 15672, 9092, 10111, 10211, 25670, 25671)
          2. ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹é»˜è®¤å¯†ç  (MySQL, Redis)
          3. å®šæœŸå¤‡ä»½é‡è¦æ•°æ® (MySQL, Redis)
          4. åŸºç¡€æœåŠ¡æŒ‰ä¾èµ–é¡ºåºéƒ¨ç½²: MySQL â†’ Redis â†’ Kafka â†’ Nginx â†’ Auth Agent â†’ åº”ç”¨æœåŠ¡
      run_once: true
      delegate_to: localhost
